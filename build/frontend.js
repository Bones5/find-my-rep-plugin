!function(){"use strict";function e(){document.querySelectorAll(".find-my-rep-container").forEach(e=>{!function(e){const t=e.querySelector(".postcode-input"),n=e.querySelector(".find-reps-btn"),r=e.querySelector(".continue-btn"),a=e.querySelector(".send-btn"),o=e.querySelector(".step-postcode"),c=e.querySelector(".step-select"),s=e.querySelector(".step-letter"),l=e.querySelector(".representatives-list"),i=e.querySelector(".letter-content"),d=e.querySelector(".error-message"),p=e.querySelector(".success-message"),m=e.querySelector(".loading-spinner");let u=[];function y(e){l.innerHTML="";let t=0;if(e.councillors&&Array.isArray(e.councillors)){const n=document.createElement("div");n.className="representatives-section";const r=document.createElement("h4");r.textContent="Local Councillors",n.appendChild(r),e.councillors.forEach(e=>{const r=function(e,t){const n=document.createElement("div");n.className="representative-item councillor-item";const r=document.createElement("input");r.type="checkbox",r.id="rep-"+t,r.setAttribute("data-rep",JSON.stringify(e));const a=document.createElement("label");return a.htmlFor="rep-"+t,a.innerHTML=`\n                <strong>${E(e.name)}</strong><br>\n                <em>${E(e.party||"Independent")}</em><br>\n                Ward: ${E(e.ward||"N/A")}<br>\n                Council: ${E(e.council||"N/A")}<br>\n                ${e.email?"Email: "+E(e.email):""}\n                ${e.phone?"<br>Phone: "+E(e.phone):""}\n            `,n.appendChild(r),n.appendChild(a),n}(e,t);n.appendChild(r),t++}),l.appendChild(n)}if(e.pcc){const n=document.createElement("div");n.className="representatives-section";const r=document.createElement("h4");r.textContent="Police and Crime Commissioner",n.appendChild(r);const a=function(e,t){const n=document.createElement("div");n.className="representative-item pcc-item";const r=document.createElement("input");r.type="checkbox",r.id="rep-"+t,r.setAttribute("data-rep",JSON.stringify(e));const a=document.createElement("label");return a.htmlFor="rep-"+t,a.innerHTML=`\n                <strong>${E(e.name)}</strong><br>\n                <em>Police and Crime Commissioner</em><br>\n                Force: ${E(e.force||"N/A")}<br>\n                Area: ${E(e.area||"N/A")}<br>\n                ${e.email?"Email: "+E(e.email):""}\n                ${e.website?'<br>Website: <a href="'+E(e.website)+'" target="_blank">'+E(e.website)+"</a>":""}\n            `,n.appendChild(r),n.appendChild(a),n}(e.pcc,t);n.appendChild(a),t++,l.appendChild(n)}e.councillors||e.pcc||!Array.isArray(e)||e.forEach(e=>{const n=function(e,t){const n=document.createElement("div");n.className="representative-item";const r=document.createElement("input");r.type="checkbox",r.id="rep-"+t,r.setAttribute("data-rep",JSON.stringify(e));const a=document.createElement("label");return a.htmlFor="rep-"+t,a.innerHTML=`\n                <strong>${E(e.name)}</strong><br>\n                <em>${E(e.title||e.type||"Representative")}</em><br>\n                ${e.email?E(e.email):""}\n            `,n.appendChild(r),n.appendChild(a),n}(e,t);l.appendChild(n),t++})}function h(e){o.style.display="none",c.style.display="none",s.style.display="none","postcode"===e?o.style.display="block":"select"===e?c.style.display="block":"letter"===e&&(s.style.display="block")}function f(e){m.style.display=e?"block":"none"}function b(e){d.textContent=e,d.style.display="block"}function E(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}n.addEventListener("click",function(){const e=t.value.trim();e?(f(!0),d.style.display="none",fetch(findMyRepData.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"find_my_rep_get_representatives",nonce:findMyRepData.nonce,postcode:e})}).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}).then(e=>{if(f(!1),"object"!=typeof e||null===e||"boolean"!=typeof e.success)throw new Error("Invalid response format");e.success&&e.data?(y(e.data),h("select")):b(e.data&&e.data.message?e.data.message:"Failed to fetch representatives.")}).catch(e=>{f(!1),b("An error occurred. Please try again."),console.error("Error:",e)})):b("Please enter a postcode.")}),r.addEventListener("click",function(){const e=l.querySelectorAll('input[type="checkbox"]:checked');0!==e.length?(u=[],e.forEach(e=>{const t=JSON.parse(e.getAttribute("data-rep"));u.push(t)}),i.value=findMyRepData.letterTemplate,h("letter")):alert("Please select at least one representative.")}),a.addEventListener("click",function(){const t=e.querySelector(".sender-name").value.trim(),n=e.querySelector(".sender-email").value.trim(),r=i.value.trim();t&&n&&r?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n)?(f(!0),fetch(findMyRepData.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"find_my_rep_send_letter",nonce:findMyRepData.nonce,sender_name:t,sender_email:n,letter_content:r,representatives:JSON.stringify(u)})}).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}).then(e=>{if(f(!1),"object"!=typeof e||null===e||"boolean"!=typeof e.success)throw new Error("Invalid response format");if(e.success&&e.data){if(p.textContent=e.data.message,p.style.display="block",a.style.display="none",e.data.errors&&e.data.errors.length>0){const t=document.createElement("ul");e.data.errors.forEach(e=>{const n=document.createElement("li");n.textContent=e,t.appendChild(n)}),p.appendChild(t)}}else{const t=e.data&&e.data.message?e.data.message:"Failed to send letters.";alert(t)}}).catch(e=>{f(!1),alert("An error occurred. Please try again."),console.error("Error:",e)})):alert("Please enter a valid email address."):alert("Please fill in all fields.")})}(e)})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e()}();